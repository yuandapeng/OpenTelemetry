# OpenTelemetry Collector æ¶æ„ç†è§£

## ğŸ¯ æ ¸å¿ƒé—®é¢˜

### å½“å‰æ¶æ„çš„å±€é™æ€§

```
åº”ç”¨ç¨‹åº
  â†“
OpenTelemetry SDK
  â†“
JaegerExporter â†’ Jaeger (åªå­˜å‚¨Traces)
```

**é—®é¢˜**ï¼š
- âŒ Jaegeråªèƒ½å­˜å‚¨å’ŒæŸ¥çœ‹Traces
- âŒ æ— æ³•æŸ¥çœ‹Logs
- âŒ æ— æ³•æŸ¥çœ‹Metrics
- âŒ ä¸‰ç§æ•°æ®ç±»å‹æ— æ³•å…³è”

## ğŸ—ï¸ å®Œæ•´çš„ä¸‰åˆä¸€æ¶æ„

### éœ€è¦ä»€ä¹ˆç»„ä»¶ï¼Ÿ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åº”ç”¨ç¨‹åº (Application)                                 â”‚
â”‚  - äº§ç”ŸTracesã€Logsã€Metrics                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OpenTelemetry SDK                                       â”‚
â”‚  - æ”¶é›†Tracesã€Logsã€Metrics                            â”‚
â”‚  - æ ¼å¼åŒ–ä¸ºOpenTelemetryæ ‡å‡†æ ¼å¼                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”‚ å‘é€åˆ°OpenTelemetry Collector
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OpenTelemetry Collector (æ ¸å¿ƒç»„ä»¶)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  1. æ¥æ”¶æ•°æ® (Receivers)                         â”‚  â”‚
â”‚  â”‚     - OTLP Receiver (æ¥æ”¶OpenTelemetryæ•°æ®)      â”‚  â”‚
â”‚  â”‚     - Jaeger Receiver                            â”‚  â”‚
â”‚  â”‚     - Prometheus Receiver                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  2. å¤„ç†æ•°æ® (Processors)                        â”‚  â”‚
â”‚  â”‚     - Resource Processor (æ·»åŠ Resourceä¿¡æ¯)      â”‚  â”‚
â”‚  â”‚     - Batch Processor (æ‰¹é‡å¤„ç†)                 â”‚  â”‚
â”‚  â”‚     - Attribute Processor (æ·»åŠ å…³è”Tag) â­       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  3. å¯¼å‡ºæ•°æ® (Exporters)                         â”‚  â”‚
â”‚  â”‚     - Jaeger Exporter â†’ Jaeger                  â”‚  â”‚
â”‚  â”‚     - Loki Exporter â†’ Loki                      â”‚  â”‚
â”‚  â”‚     - Prometheus Exporter â†’ Prometheus          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚          â”‚          â”‚
        â–¼          â–¼          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚Jaeger â”‚ â”‚ Loki  â”‚ â”‚Prometheusâ”‚
    â”‚(Traces)â”‚ â”‚(Logs) â”‚ â”‚(Metrics)â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”‘ å…³é”®ï¼šOpenTelemetry Collectorçš„ä½œç”¨

### 1. ç»Ÿä¸€æ¥æ”¶ç‚¹

```
æ²¡æœ‰Collectorï¼š
åº”ç”¨ç¨‹åº1 â†’ JaegerExporter â†’ Jaeger
åº”ç”¨ç¨‹åº2 â†’ PrometheusExporter â†’ Prometheus
åº”ç”¨ç¨‹åº3 â†’ LokiExporter â†’ Loki
ï¼ˆæ¯ä¸ªåº”ç”¨éƒ½è¦é…ç½®å¤šä¸ªexporterï¼‰

æœ‰Collectorï¼š
åº”ç”¨ç¨‹åº1 â”
åº”ç”¨ç¨‹åº2 â”œâ†’ OpenTelemetry Collector â†’ åˆ†å‘åˆ°å„ä¸ªåç«¯
åº”ç”¨ç¨‹åº3 â”˜
ï¼ˆåº”ç”¨åªéœ€è¦å‘é€åˆ°Collectorï¼ŒCollectorè´Ÿè´£åˆ†å‘ï¼‰
```

### 2. æ•°æ®å…³è”ï¼ˆæ‰“Tagï¼‰

è¿™æ˜¯æœ€å…³é”®çš„åŠŸèƒ½ï¼

#### é—®é¢˜ï¼šå¦‚ä½•å…³è”Traceå’ŒLogï¼Ÿ

```
Traceæ•°æ®ï¼š
  traceId: "abc123"
  spanId: "def456"
  service: "service-a"

Logæ•°æ®ï¼š
  message: "å¤„ç†ç”¨æˆ·è¯·æ±‚"
  level: "info"
  timestamp: "2024-01-01 10:00:00"
  
âŒ é—®é¢˜ï¼šå¦‚ä½•çŸ¥é“è¿™ä¸ªLogå±äºå“ªä¸ªTraceï¼Ÿ
```

#### è§£å†³æ–¹æ¡ˆï¼šCollectoræ·»åŠ å…³è”Tag

```
Collectorå¤„ç†æµç¨‹ï¼š

1. æ¥æ”¶Traceæ•°æ®
   traceId: "abc123"
   spanId: "def456"
   service: "service-a"
   
2. æ¥æ”¶Logæ•°æ®
   message: "å¤„ç†ç”¨æˆ·è¯·æ±‚"
   traceId: "abc123"  â† ä»Logä¸Šä¸‹æ–‡ä¸­æå–
   spanId: "def456"   â† ä»Logä¸Šä¸‹æ–‡ä¸­æå–
   
3. Collectoræ·»åŠ å…³è”Tag
   Traceæ•°æ®æ·»åŠ ï¼š
     - trace.trace_id: "abc123"
     - trace.span_id: "def456"
     - service.name: "service-a"
     - resource.attributes: {...}
   
   Logæ•°æ®æ·»åŠ ï¼š
     - trace.trace_id: "abc123"  â† å…³é”®ï¼å…³è”Tag
     - trace.span_id: "def456"   â† å…³é”®ï¼å…³è”Tag
     - service.name: "service-a"
     - resource.attributes: {...}
   
4. åˆ†åˆ«å‘é€åˆ°åç«¯
   Trace â†’ Jaeger (å¸¦tag)
   Log â†’ Loki (å¸¦tag)
   
5. åœ¨å¯è§†åŒ–å·¥å…·ä¸­å…³è”æŸ¥è¯¢
   åœ¨Jaegerä¸­çœ‹åˆ°Traceï¼Œå¯ä»¥é€šè¿‡traceIdæŸ¥æ‰¾å¯¹åº”çš„Log
   åœ¨Lokiä¸­çœ‹åˆ°Logï¼Œå¯ä»¥é€šè¿‡traceIdæŸ¥æ‰¾å¯¹åº”çš„Trace
```

## ğŸ“Š å®é™…é…ç½®ç¤ºä¾‹

### OpenTelemetry Collectoré…ç½®

```yaml
# collector-config.yaml
receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

processors:
  # æ·»åŠ Resourceä¿¡æ¯ï¼ˆæœåŠ¡åã€ç‰ˆæœ¬ç­‰ï¼‰
  resource:
    attributes:
      - key: service.name
        from_attribute: service.name
        action: upsert
  
  # æ‰¹é‡å¤„ç†
  batch:
  
  # æ·»åŠ å…³è”Tagï¼ˆå…³é”®ï¼ï¼‰
  attributes:
    actions:
      # ç¡®ä¿æ‰€æœ‰æ•°æ®éƒ½æœ‰traceIdå’ŒspanId
      - key: trace.trace_id
        from_attribute: trace_id
        action: insert
      - key: trace.span_id
        from_attribute: span_id
        action: insert

exporters:
  # å¯¼å‡ºTracesåˆ°Jaeger
  jaeger:
    endpoint: jaeger:14250
    tls:
      insecure: true
  
  # å¯¼å‡ºLogsåˆ°Loki
  loki:
    endpoint: http://loki:3100/loki/api/v1/push
    labels:
      resource:
        service.name: "service_name"
      attributes:
        trace.trace_id: "trace_id"  # å…³é”®ï¼å…³è”Tag
        trace.span_id: "span_id"    # å…³é”®ï¼å…³è”Tag
  
  # å¯¼å‡ºMetricsåˆ°Prometheus
  prometheus:
    endpoint: "0.0.0.0:8889"

service:
  pipelines:
    traces:
      receivers: [otlp]
      processors: [resource, attributes, batch]
      exporters: [jaeger]
    
    logs:
      receivers: [otlp]
      processors: [resource, attributes, batch]
      exporters: [loki]
    
    metrics:
      receivers: [otlp]
      processors: [resource, attributes, batch]
      exporters: [prometheus]
```

## ğŸ”— æ•°æ®å…³è”æœºåˆ¶

### 1. Trace Contextä¼ æ’­

```
è¯·æ±‚æµç¨‹ï¼š
1. å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚
   â†’ ç”ŸæˆtraceId: "abc123"
   â†’ ç”ŸæˆspanId: "def456"
   
2. Trace Contextæ³¨å…¥åˆ°HTTPå¤´
   traceparent: 00-abc123-def456-01
   
3. æœåŠ¡å¤„ç†è¯·æ±‚
   â†’ ä»HTTPå¤´æå–traceIdå’ŒspanId
   â†’ åˆ›å»ºæ–°çš„spanï¼ˆç»§æ‰¿traceIdï¼‰
   â†’ è®°å½•Logæ—¶åŒ…å«traceIdå’ŒspanId
   
4. OpenTelemetry SDKæ”¶é›†
   Traceæ•°æ®: {traceId: "abc123", spanId: "def456", ...}
   Logæ•°æ®: {message: "...", traceId: "abc123", spanId: "def456", ...}
   
5. Collectoræ¥æ”¶å¹¶æ·»åŠ Tag
   Trace â†’ æ·»åŠ  resource.attributes
   Log â†’ æ·»åŠ  trace.trace_id, trace.span_id (å…³è”Tag)
   
6. åˆ†åˆ«å­˜å‚¨
   Jaegerå­˜å‚¨Traceï¼ˆå¸¦tagï¼‰
   Lokiå­˜å‚¨Logï¼ˆå¸¦tagï¼‰
   
7. å…³è”æŸ¥è¯¢
   åœ¨Jaegerä¸­ç‚¹å‡»Trace â†’ é€šè¿‡traceIdæŸ¥è¯¢Lokiä¸­çš„Log
   åœ¨Lokiä¸­ç‚¹å‡»Log â†’ é€šè¿‡traceIdæŸ¥è¯¢Jaegerä¸­çš„Trace
```

### 2. å¯è§†åŒ–å…³è”

```
Grafana Dashboardç¤ºä¾‹ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Traceè¯¦æƒ… (æ¥è‡ªJaeger)              â”‚
â”‚  traceId: abc123                    â”‚
â”‚  [æŸ¥çœ‹å…³è”çš„Logs] â† ç‚¹å‡»æŒ‰é’®         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å…³è”çš„Logs (æ¥è‡ªLoki)                â”‚
â”‚  æŸ¥è¯¢: {trace_id="abc123"}          â”‚
â”‚  - 10:00:00 [INFO] å¤„ç†è¯·æ±‚å¼€å§‹     â”‚
â”‚  - 10:00:01 [INFO] è°ƒç”¨æ•°æ®åº“       â”‚
â”‚  - 10:00:02 [INFO] å¤„ç†å®Œæˆ         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦Collectorï¼Ÿ

### ä¼˜åŠ¿1ï¼šç»Ÿä¸€ç®¡ç†
- æ‰€æœ‰åº”ç”¨åªéœ€å‘é€åˆ°Collector
- Collectorè´Ÿè´£åˆ†å‘åˆ°å„ä¸ªåç«¯
- ç®€åŒ–åº”ç”¨é…ç½®

### ä¼˜åŠ¿2ï¼šæ•°æ®å…³è”
- Collectorå¯ä»¥ç»™æ‰€æœ‰æ•°æ®æ·»åŠ ç»Ÿä¸€çš„å…³è”Tag
- ç¡®ä¿Tracesã€Logsã€Metricsä½¿ç”¨ç›¸åŒçš„æ ‡è¯†ç¬¦
- å®ç°è·¨ç³»ç»Ÿçš„å…³è”æŸ¥è¯¢

### ä¼˜åŠ¿3ï¼šæ•°æ®å¤„ç†
- æ•°æ®è¿‡æ»¤ã€è½¬æ¢ã€é‡‡æ ·
- æ‰¹é‡å¤„ç†æé«˜æ€§èƒ½
- ç»Ÿä¸€æ·»åŠ å…ƒæ•°æ®

### ä¼˜åŠ¿4ï¼šè§£è€¦
- åº”ç”¨ä¸éœ€è¦çŸ¥é“åç«¯å­˜å‚¨ç³»ç»Ÿ
- å¯ä»¥éšæ—¶åˆ‡æ¢åç«¯ï¼ˆåªéœ€ä¿®æ”¹Collectoré…ç½®ï¼‰
- æ”¯æŒå¤šä¸ªåç«¯åŒæ—¶å­˜å‚¨

## ğŸ“ æ€»ç»“

| ç»„ä»¶ | ä½œç”¨ | å­˜å‚¨å†…å®¹ |
|------|------|---------|
| **Jaeger** | å­˜å‚¨å’ŒæŸ¥çœ‹Traces | åªå­˜Traces |
| **Loki** | å­˜å‚¨å’ŒæŸ¥çœ‹Logs | åªå­˜Logs |
| **Prometheus** | å­˜å‚¨å’ŒæŸ¥çœ‹Metrics | åªå­˜Metrics |
| **OpenTelemetry Collector** | æ¥æ”¶ã€å¤„ç†ã€åˆ†å‘æ•°æ® | ä¸å­˜å‚¨ï¼Œåªè½¬å‘ |
| **å…³è”æœºåˆ¶** | é€šè¿‡traceId/spanIdå…³è” | Collectoræ·»åŠ å…³è”Tag |

**å…³é”®ç†è§£**ï¼š
1. æ¯ä¸ªæ•°æ®ç±»å‹éœ€è¦ç‹¬ç«‹çš„å­˜å‚¨ç»„ä»¶
2. Collectorè´Ÿè´£ç»Ÿä¸€æ¥æ”¶å’Œåˆ†å‘
3. Collectoræ·»åŠ å…³è”Tagï¼Œè®©ä¸åŒç³»ç»Ÿçš„æ•°æ®å¯ä»¥å…³è”æŸ¥è¯¢
4. é€šè¿‡traceIdå¯ä»¥åœ¨Jaegerå’ŒLokiä¹‹é—´è·³è½¬

